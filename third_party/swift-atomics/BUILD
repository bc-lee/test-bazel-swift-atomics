load("@build_bazel_rules_swift//swift:swift.bzl", "swift_interop_hint", "swift_library")

swift_library(
    name = "Atomics",
    srcs = [
        "Sources/Atomics/Conformances/OptionalRawRepresentable.swift",
        "Sources/Atomics/Conformances/RawRepresentable.swift",
        "Sources/Atomics/Conformances/autogenerated/AtomicBool.swift",
        "Sources/Atomics/Conformances/autogenerated/IntegerConformances.swift",
        "Sources/Atomics/Conformances/autogenerated/PointerConformances.swift",
        "Sources/Atomics/Primitives/autogenerated/Primitives.native.swift",
        "Sources/Atomics/Primitives/autogenerated/Primitives.shims.swift",
        "Sources/Atomics/Protocols/AtomicInteger.swift",
        "Sources/Atomics/Protocols/AtomicOptionalWrappable.swift",
        "Sources/Atomics/Protocols/AtomicReference.swift",
        "Sources/Atomics/Protocols/AtomicStorage.swift",
        "Sources/Atomics/Protocols/AtomicValue.swift",
        "Sources/Atomics/Types/AtomicMemoryOrderings.swift",
        "Sources/Atomics/Types/DoubleWord.swift",
        "Sources/Atomics/Types/ManagedAtomic.swift",
        "Sources/Atomics/Types/ManagedAtomicLazyReference.swift",
        "Sources/Atomics/Types/UnsafeAtomic.swift",
        "Sources/Atomics/Types/UnsafeAtomicLazyReference.swift",
        "Sources/Atomics/Types/autogenerated/IntegerOperations.swift",
        "Sources/Atomics/Unmanaged extensions.swift",
    ],
    copts = [
        "-enable-experimental-feature",
        "BuiltinModule",
        "-Xcc",
        "-DATOMICS_NATIVE_BUILTINS",
    ],
    defines = [
        "ATOMICS_NATIVE_BUILTINS",
    ],
    module_name = "Atomics",
    visibility = ["//visibility:public"],
    deps = [
        ":_AtomicsShims",
    ],
    # Without this, final binary will not be linked correctly
    # See https://github.com/bazelbuild/rules_swift/issues/1059#issuecomment-1595847116
    alwayslink = 1,
)

cc_library(
    name = "_AtomicsShims",
    srcs = [
        "Sources/_AtomicsShims/include/_AtomicsShims.h",
        "Sources/_AtomicsShims/src/_AtomicsShims.c",
    ],
    aspect_hints = [":_AtomicsShims_swift_interop"],
    defines = [
        "ATOMICS_NATIVE_BUILTINS=1",
    ],
    includes = [
        "Sources/_AtomicsShims/include",
    ],
    visibility = ["//visibility:public"],
)

swift_interop_hint(
    name = "_AtomicsShims_swift_interop",
    module_map = "Sources/_AtomicsShims/include/module.modulemap",
    module_name = "_AtomicsShims",
)
